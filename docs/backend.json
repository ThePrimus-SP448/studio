{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the StockWise application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "username": {
          "type": "string",
          "description": "Username of the user."
        },
        "registrationDate": {
          "type": "string",
          "description": "Date and time the user registered.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "username",
        "registrationDate"
      ]
    },
    "Stock": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Stock",
      "type": "object",
      "description": "Represents a stock listed on the market.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the stock entity."
        },
        "ticker": {
          "type": "string",
          "description": "Stock ticker symbol (e.g., AAPL)."
        },
        "name": {
          "type": "string",
          "description": "Name of the company (e.g., Apple Inc.)."
        },
        "currentPrice": {
          "type": "number",
          "description": "Current market price of the stock."
        },
        "lastUpdated": {
          "type": "string",
          "description": "Date and time the stock information was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "ticker",
        "name",
        "currentPrice",
        "lastUpdated"
      ]
    },
    "Transaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Transaction",
      "type": "object",
      "description": "Represents a virtual stock transaction made by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the transaction entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Transaction)"
        },
        "stockId": {
          "type": "string",
          "description": "Reference to Stock. (Relationship: Stock 1:N Transaction)"
        },
        "transactionType": {
          "type": "string",
          "description": "Type of transaction (buy or sell)."
        },
        "quantity": {
          "type": "number",
          "description": "Number of shares bought or sold."
        },
        "price": {
          "type": "number",
          "description": "Price per share at the time of the transaction."
        },
        "transactionDate": {
          "type": "string",
          "description": "Date and time of the transaction.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "stockId",
        "transactionType",
        "quantity",
        "price",
        "transactionDate"
      ]
    },
    "Portfolio": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Portfolio",
      "type": "object",
      "description": "Represents a user's stock portfolio.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the portfolio entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Portfolio)"
        },
        "stockId": {
          "type": "string",
          "description": "Reference to Stock. (Relationship: Stock 1:N Portfolio)"
        },
        "quantity": {
          "type": "number",
          "description": "Number of shares currently held in the portfolio."
        },
        "averagePrice": {
          "type": "number",
          "description": "Average purchase price of the shares in the portfolio."
        }
      },
      "required": [
        "id",
        "userId",
        "stockId",
        "quantity",
        "averagePrice"
      ]
    },
    "InvestmentRecommendation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "InvestmentRecommendation",
      "type": "object",
      "description": "Represents an investment recommendation generated by the AI tool.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the recommendation."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N InvestmentRecommendation)"
        },
        "stockId": {
          "type": "string",
          "description": "Reference to Stock. (Relationship: Stock 1:N InvestmentRecommendation)"
        },
        "recommendationType": {
          "type": "string",
          "description": "Type of recommendation (e.g., buy, sell, hold)."
        },
        "confidenceLevel": {
          "type": "number",
          "description": "Confidence level of the recommendation (0-1)."
        },
        "rationale": {
          "type": "string",
          "description": "Explanation or reasoning behind the recommendation."
        },
        "generatedDate": {
          "type": "string",
          "description": "Date and time the recommendation was generated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "stockId",
        "recommendationType",
        "confidenceLevel",
        "rationale",
        "generatedDate"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Access is restricted to the user themselves. Uses path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/transactions/{transactionId}",
        "definition": {
          "entityName": "Transaction",
          "schema": {
            "$ref": "#/backend/entities/Transaction"
          },
          "description": "Stores transaction data for a specific user. Access is restricted to the user. Uses path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "transactionId",
              "description": "The unique identifier of the transaction."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/portfolios/{portfolioId}",
        "definition": {
          "entityName": "Portfolio",
          "schema": {
            "$ref": "#/backend/entities/Portfolio"
          },
          "description": "Stores portfolio data for a specific user. Access is restricted to the user. Uses path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "portfolioId",
              "description": "The unique identifier of the portfolio."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/recommendations/{recommendationId}",
        "definition": {
          "entityName": "InvestmentRecommendation",
          "schema": {
            "$ref": "#/backend/entities/InvestmentRecommendation"
          },
          "description": "Stores investment recommendations for a specific user. Access is restricted to the user. Uses path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "recommendationId",
              "description": "The unique identifier of the investment recommendation."
            }
          ]
        }
      },
      {
        "path": "/stocks/{stockId}",
        "definition": {
          "entityName": "Stock",
          "schema": {
            "$ref": "#/backend/entities/Stock"
          },
          "description": "Stores stock data. Publicly readable, but write access is restricted to authorized services.",
          "params": [
            {
              "name": "stockId",
              "description": "The unique identifier of the stock."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide a secure and scalable backend for the StockWise application, focusing on user-specific data and collaborative data where appropriate.  Authorization Independence is achieved by using path-based ownership for user-specific data and by denormalizing user IDs into the `members` map of the shared data. Segregation is achieved by using path based ownership and separating private from collaborative data. This approach enables clear and maintainable security rules, ensuring only authorized users can access specific data.\n\n**Explanation of Structure and Authorization Independence:**\n\n*   **/users/{userId}/**:  This path stores user profiles. Access is restricted to the user themselves (path-based ownership). No `get()` calls are needed for authorization.\n*   **/users/{userId}/transactions/{transactionId}/**: Transactions are stored as a subcollection of the user. This enforces ownership; only the user can access their transactions. Authorization is based on the `userId` in the path, not on the transaction data itself.\n*   **/users/{userId}/portfolios/{portfolioId}/**:  Portfolios are also stored as a subcollection of the user.  Access is controlled via path-based ownership.\n*   **/users/{userId}/recommendations/{recommendationId}/**: Recommendations are also stored as a subcollection of the user.  Access is controlled via path-based ownership.\n*   **/stocks/{stockId}/**:  This collection stores stock data, which is publicly accessible. Therefore, no authorization is needed for reading. Writes should be restricted to authorized services only (e.g., using a service account).\n\n**QAPs (Rules are not Filters):**\n\nThe structure is designed to prevent filtering on the client side by ensuring that each collection contains documents with a homogeneous security posture.  For example:\n\n*   `list` operations on `/users/{userId}/transactions` are safe because all documents in this collection are owned by the user identified by `{userId}`.\n*   `list` operations on `/stocks` are safe because the data is publicly readable. Write access, however, is restricted at the path level.\n\nThis segregation avoids the need for complex filtering logic in the security rules, thus adhering to the principle that rules are not filters."
  }
}